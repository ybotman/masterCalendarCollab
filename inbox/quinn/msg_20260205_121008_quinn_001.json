{
  "from": "quinn",
  "to": ["quinn"],
  "cc": ["gotan"],
  "subject": "FB Conditioner Codebase Update — Mastered City + Required Event Fields Complete",
  "priority": "high",
  "timestamp": "2026-02-05T20:00:00Z",
  "body": "SELF-NOTE: FB Conditioner Pipeline Code Changes (2026-02-05)\n\n== CONTEXT ==\n\nWorking with Toby on completing the fb-conditioner pipeline for AI-discovered events. The main issue was discovered events in TEST MongoDB were missing required fields for map grouping (masteredCityName, etc.). Toby confirmed the 21 missing mastered cities have been built out.\n\n== REQUIRED EVENT FIELDS (per Fulton) ==\n\nAll discovered events MUST have these denormalized fields for FE map grouping:\n\n┌─────────────────────────┬────────────────────────────┐\n│     Field on Event      │          Used For          │\n├─────────────────────────┼────────────────────────────┤\n│ masteredCityName        │ City level grouping + name │\n│ masteredCityGeolocation │ City centroid coordinates  │\n│ masteredDivisionName    │ Division level grouping    │\n│ masteredRegionName      │ Region level grouping      │\n│ masteredCountryName     │ Country level grouping     │\n│ venueName               │ Venue level name           │\n│ venueGeolocation        │ Venue coordinates          │\n│ categoryFirst           │ Pill categorization        │\n│ isDiscovered            │ AI-Discv pill              │\n└─────────────────────────┴────────────────────────────┘\n\nContinent is derived FE-side from country → continent lookup map.\n\n== CODE CHANGES MADE ==\n\n1. load-events.ts:\n   - Added masteredCountryName resolution (from masteredcountries collection)\n   - Added venueName to event document\n   - VenueInfo interface now includes masteredCountryName\n   - resolveVenue() walks full hierarchy: city → division → region → country\n   - If venue has no masteredCityId, falls back to $near on venue geolocation\n   - Backfill function also populates masteredCountryName and venueName\n   - Added --poc-thin mode (3 items, verbose, verifies all required fields)\n\n2. load-venues.ts:\n   - Nearest mastered city resolution on new venue insert\n   - Structured address from Nominatim (address1/address2/zip)\n   - Added --poc-thin mode\n\n3. geocode.ts:\n   - Returns structured address components from Nominatim\n   - Supports international addresses (removed US-only restriction)\n\n4. store.ts:\n   - Migration adds venue address columns (house_number, road, suburb, postcode, country_code)\n\n5. types.ts:\n   - GeocodeAddress interface\n   - DbVenue address fields\n   - VenueInfo masteredCountryName\n\n6. run-weekly.ts, scrape-and-load.ts, batch-pipeline.ts:\n   - Store structured address from geocoding\n\n7. Documentation:\n   - CLAUDE.md updated with --poc-thin commands, CLI flags, mastered city docs\n   - ROLLOUT-CHECKLIST.md created with full task tracking\n\n== FILES MODIFIED (uncommitted) ==\n\n M scripts/batch-pipeline.ts\n M scripts/geocode.ts\n M scripts/load-events.ts\n M scripts/load-venues.ts\n M scripts/run-weekly.ts\n M scripts/scrape-and-load.ts\n M scripts/store.ts\n M scripts/types.ts\n M CLAUDE.md\n M ROLLOUT-CHECKLIST.md\n\n== WHAT TOBY DID ==\n\n- Built out 21 missing mastered cities (12 US + 9 international)\n- Working on map aggregation feature with category pills\n- Confirmed required event fields with Fulton\n- Holding on TIEMPO-360 (event density overlay)\n\n== NEXT STEPS ==\n\n1. Commit these code changes\n2. Run --poc-thin to verify end-to-end (3 items)\n3. Drop TEST discovered events (290 missing masteredCityName)\n4. Reset SQLite sync status\n5. Full reload to TEST\n6. Validate in TangoTiempo UI\n7. Then PROD\n\n== CRITICAL REMINDERS ==\n\n- Mastered city fields are for REGIONAL ADMIN OWNERSHIP only\n- Geographic filtering uses actual venue lat/lng (venueGeolocation), NOT masteredCityGeolocation\n- All code compiles clean (node --experimental-strip-types --check)\n- 46 rate-limited groups still need re-scraping (separate issue)\n\n— Quinn"
}
