{
  "from": "sarah",
  "to": ["fulton"],
  "subject": "TIEMPO-360: Replace masteredXXX grouping with coordinate grid bucketing",
  "priority": "high",
  "timestamp": "2026-02-04T",
  "ticket": "TIEMPO-360",
  "body": "Hey Fulton,\n\nFollow-up on the broken region clustering. El Gotan confirmed: don't use masteredRegionId/masteredDivisionId/masteredCityId for grouping -- they're not reliably populated.\n\nInstead, use COORDINATE GRID BUCKETING. Events already have venueGeolocation and masteredCityGeolocation denormalized on them. Group by rounding the coordinates to different precisions based on zoom:\n\nZoom 1-5 (continental): Round lat/lng to nearest 5 degrees\nZoom 6-10 (metro): Round lat/lng to nearest 1 degree\nZoom 11-14 (neighborhood): Round lat/lng to nearest 0.1 degree\nZoom 15+ (venue): Group by $venueID (this is fine as-is)\n\nMongoDB aggregation example for zoom 1-5:\n```\n{\n  $group: {\n    _id: {\n      latBucket: { $multiply: [{ $round: [{ $divide: [{ $ifNull: [{ $arrayElemAt: ['$venueGeolocation.coordinates', 1] }, { $arrayElemAt: ['$masteredCityGeolocation.coordinates', 1] }] }, 5] }, 0] }, 5] },\n      lngBucket: { $multiply: [{ $round: [{ $divide: [{ $ifNull: [{ $arrayElemAt: ['$venueGeolocation.coordinates', 0] }, { $arrayElemAt: ['$masteredCityGeolocation.coordinates', 0] }] }, 5] }, 0] }, 5] }\n    },\n    eventCount: { $sum: 1 },\n    discoveredCount: { $sum: { $cond: ['$isAIDiscovered', 1, 0] } },\n    regularCount: { $sum: { $cond: ['$isAIDiscovered', 0, 1] } },\n    lat: { $avg: { $ifNull: [{ $arrayElemAt: ['$venueGeolocation.coordinates', 1] }, { $arrayElemAt: ['$masteredCityGeolocation.coordinates', 1] }] } },\n    lng: { $avg: { $ifNull: [{ $arrayElemAt: ['$venueGeolocation.coordinates', 0] }, { $arrayElemAt: ['$masteredCityGeolocation.coordinates', 0] }] } }\n  }\n}\n```\n\nKey points:\n- Use $avg for center coords (not $first) so the dot is at the geographic centroid\n- Use $ifNull cascade: venueGeolocation first, masteredCityGeolocation fallback\n- For the cluster 'name', use the nearest major city or just format as 'lat, lng area'\n- canDrillDown: true for all zoom tiers except venue level\n- No $lookup needed -- everything is on the event document already\n\nThis replaces the entire masteredXXX grouping approach. Zoom 15+ venueID grouping stays the same.\n\nThanks!\n- Sarah"
}
