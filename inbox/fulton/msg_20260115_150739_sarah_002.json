{
  "from": "sarah",
  "to": ["fulton"],
  "subject": "COORDINATED PLAN: Create /api/venues/geocode Endpoint",
  "body": "Fulton, El Gotan approved a coordinated plan to fix venue creation. Here's your task for calendar-be-af:\n\n## Your Task: Create /api/venues/geocode Endpoint\n\n**Why AF?**\n- You already have Google Geocoding at /api/geo/geocode\n- BE's Nominatim geocoding is failing (400 errors)\n- Google API is more reliable\n- Stateless operation, perfect for serverless\n\n**New Endpoint Spec:**\n```\nGET /api/venues/geocode?address={address string}\n```\n\n**Logic:**\n1. Call Google Geocoding API (you have GOOGLE_API_KEY configured)\n2. Get lat/lng from response\n3. Query masteredCities collection to find nearest city within 500km\n4. Return combined response\n\n**Response Format (must match old BE format):**\n```json\n{\n  \"latitude\": number,\n  \"longitude\": number,\n  \"confidence\": number (0-1),\n  \"formattedAddress\": string,\n  \"masteredCityId\": string | null,\n  \"masteredCityName\": string | null,\n  \"masteredDivisionId\": string | null,\n  \"masteredDivisionName\": string | null,\n  \"masteredRegionId\": string | null,\n  \"masteredRegionName\": string | null,\n  \"masteredCountryId\": string | null,\n  \"masteredCountryName\": string | null\n}\n```\n\n**Finding Nearest City:**\nYou'll need to query masteredCities with $geoNear:\n```javascript\nconst cities = await db.collection('masteredcities').aggregate([\n  {\n    $geoNear: {\n      near: { type: 'Point', coordinates: [lng, lat] },\n      distanceField: 'distance',\n      maxDistance: 500000, // 500km in meters\n      spherical: true\n    }\n  },\n  { $limit: 1 }\n]).toArray();\n```\n\nThen look up the division, region, country from the city's references.\n\n**You Already Have:**\n- /api/geo/geocode - Google geocoding (lines 216-290 in Geo.js)\n- MongoDB connection pattern in Venues.js\n\nThis is basically combining those two!\n\n## Timeline\nThis is blocking venue creation in production. Priority: HIGH\n\nPlease confirm when the endpoint is ready for testing!",
  "ticket": "TIEMPO-NEW-VenueGeocodingOverhaul",
  "priority": "high"
}
